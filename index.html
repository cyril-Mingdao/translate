<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 雙向智能翻譯機 (v3.4)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS 保持不變 */
        :root { --primary-color: #4285F4; --secondary-color: #34A853; --danger-color: #d93025; --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333; --mirrored-bg-top: #e8f0fe; --mirrored-bg-bottom: #e6f4ea; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; color: var(--text-color); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header-controls { position: fixed; top: 15px; right: 15px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; gap: 8px; backdrop-filter: blur(5px); }
        .ctrl-btn { background: none; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 14px; color: #555; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .ctrl-btn.active { background-color: var(--primary-color); color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; }
        .custom-window { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateY(20px); transition: transform 0.3s ease; }
        .modal-overlay.show .custom-window { transform: translateY(0); }
        .custom-window h3 { margin-top: 0; color: var(--primary-color); font-size: 1.3rem;}
        .custom-window p { color: #666; font-size: 15px; line-height: 1.5; }
        .input-group { position: relative; margin: 20px 0; }
        .custom-window input { width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; transition: border 0.3s; outline: none; background: #fafafa; }
        .custom-window input:focus { border-color: var(--primary-color); background: #fff; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-primary, .btn-secondary, .btn-danger { padding: 10px 20px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; flex: 1; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: #eee; color: #555; }
        .btn-danger { background: var(--danger-color); color: white; }
        .modal-note { font-size: 12px; color: #999; margin-top: 15px; }
        .modal-note a { color: var(--primary-color); text-decoration: none; }
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 100%; align-items: center; }
        .toast { background: rgba(40, 40, 40, 0.95); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #d93025; }
        #textModeContainer { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        .text-card { background-color: var(--card-bg); width: 100%; max-width: 600px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        h2.app-title { text-align: center; color: var(--primary-color); margin-bottom: 20px; font-size: 1.5rem;}
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        select { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #fff; appearance: none; cursor: pointer;}
        .swap-btn { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--primary-color); padding: 10px; border-radius: 50%; transition: background 0.2s; }
        .swap-btn:hover { background: #e8f0fe; }
        textarea { width: 100%; height: 120px; padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 18px; resize: none; font-family: inherit; margin-bottom: 15px; transition: border 0.3s; }
        textarea:focus { outline: none; border-color: var(--primary-color); }
        .output-box { background-color: #f8f9fa; color: #444; border: 1px solid #eee;}
        button.translate-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.2s; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); }
        button.translate-btn:active { transform: scale(0.98); }
        button.translate-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        .loading-text { display: none; text-align: center; margin-top: 15px; color: #666; font-size: 14px; }
        #voiceMirroredContainer { display: none; flex-direction: column; height: 100%; width: 100%; background: #fff; }
        .half-screen { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; position: relative; }
        .top-half { background-color: var(--mirrored-bg-top); transform: rotate(180deg); border-bottom: 1px solid #ccdcee; }
        .bottom-half { background-color: var(--mirrored-bg-bottom); border-top: 1px solid #cce5d0; }
        .lang-label { font-weight: bold; color: #555; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 15px; align-self: flex-start; }
        .speech-bubble { background: white; padding: 15px; border-radius: 18px; margin-bottom: 10px; font-size: 18px; min-height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); word-break: break-word; line-height: 1.4; border: 1px solid rgba(0,0,0,0.05); }
        .speech-bubble.translated { background: #fff; color: var(--primary-color); border-left: 4px solid var(--primary-color); }
        .bottom-half .speech-bubble.translated { border-color: var(--secondary-color); color: var(--secondary-color); }
        .mic-controls { margin-top: auto; display: flex; justify-content: center; padding-top: 15px; }
        .mic-btn { width: 70px; height: 70px; border-radius: 50%; border: none; background-color: var(--primary-color); color: white; font-size: 28px; cursor: pointer; box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4); transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .mic-btn:active { transform: scale(0.9); }
        .bottom-half .mic-btn { background-color: var(--secondary-color); box-shadow: 0 6px 15px rgba(52, 168, 83, 0.4); }
        .mic-btn.listening { animation: pulse 1.5s infinite; background-color: var(--danger-color) !important; box-shadow: 0 6px 15px rgba(217, 48, 37, 0.4); }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(217, 48, 37, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(217, 48, 37, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(217, 48, 37, 0); } }
        @media (max-width: 480px) { .text-card { padding: 20px; width: 95%; margin-top: 50px; } .mic-btn { width: 64px; height: 64px; } .custom-window { width: 85%; } }
    </style>
</head>
<body>

    <div class="header-controls">
        <button class="ctrl-btn active" onclick="switchMode('text')" id="textModeBtn"><i class="fas fa-keyboard"></i> 文字</button>
        <button class="ctrl-btn" onclick="switchMode('voice')" id="voiceModeBtn"><i class="fas fa-microphone-alt"></i> 語音鏡像</button>
        <button class="ctrl-btn" onclick="openSettings()" title="設定"><i class="fas fa-cog"></i></button>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="custom-window">
            <h3><i class="fas fa-key"></i> 設定 API Key</h3>
            <p>請輸入 Google Gemini API Key。</p>
            <div class="input-group">
                <input type="password" id="apiKeyInput" placeholder="請貼上 API Key">
            </div>
            <div class="btn-group">
                <button class="btn-secondary" onclick="closeSettings()">取消</button>
                <button class="btn-primary" onclick="saveApiKey()">儲存設定</button>
            </div>
             <div class="modal-note"><a href="https://aistudio.google.com/app/apikey" target="_blank">取得免費 Key &rarr;</a></div>
             <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                <button class="btn-danger" style="font-size:14px; padding:8px;" onclick="confirmReset()"><i class="fas fa-trash"></i> 清除 Key</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay">
        <div class="custom-window">
            <h3 style="color:var(--danger-color)"><i class="fas fa-exclamation-triangle"></i> 確認清除</h3>
            <p>確定要刪除 API Key 嗎？</p>
            <div class="btn-group">
                <button class="btn-secondary" onclick="closeConfirm()">取消</button>
                <button class="btn-danger" onclick="executeReset()">確定清除</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="textModeContainer">
        <div class="text-card">
            <h2 class="app-title"><i class="fas fa-robot"></i> AI 智能翻譯機 (v3.4)</h2>
            <div class="controls">
                <select id="textSourceLang"></select>
                <button class="swap-btn" onclick="swapTextLanguages()"><i class="fas fa-exchange-alt"></i></button>
                <select id="textTargetLang"></select>
            </div>
            <textarea id="textInput" placeholder="請輸入要翻譯的文字..."></textarea>
            <textarea id="textOutput" class="output-box" placeholder="翻譯結果..." readonly></textarea>
            <button id="textTranslateBtn" class="translate-btn" onclick="doTextTranslation()">開始翻譯</button>
            <div id="textLoading" class="loading-text"><i class="fas fa-spinner fa-spin"></i> Gemini 正在思考中...</div>
        </div>
    </div>

    <div id="voiceMirroredContainer">
        <div class="half-screen top-half">
            <div class="lang-label"><i class="fas fa-user-friends"></i> 對方 (<span id="topLangLabel"></span>)</div>
            <div id="topOriginalText" class="speech-bubble" placeholder="聆聽中..."></div>
            <div id="topTranslatedText" class="speech-bubble translated" placeholder="翻譯結果..."></div>
            <div class="mic-controls">
                <button id="topMicBtn" class="mic-btn" onmousedown="startListening('top')" onmouseup="stopListening()" ontouchstart="startListening('top')" ontouchend="stopListening()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="half-screen bottom-half">
            <div class="lang-label"><i class="fas fa-user"></i> 我方 (<span id="bottomLangLabel"></span>)</div>
            <div id="bottomOriginalText" class="speech-bubble" placeholder="聆聽中..."></div>
            <div id="bottomTranslatedText" class="speech-bubble translated" placeholder="翻譯結果..."></div>
            <div class="mic-controls">
                <button id="bottomMicBtn" class="mic-btn" onmousedown="startListening('bottom')" onmouseup="stopListening()" ontouchstart="startListening('bottom')" ontouchend="stopListening()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
    function showToast(message, type = 'normal') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = 'toast' + (type === 'error' ? ' error' : '');
        toast.innerText = message;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3500);
    }
    function openModal(id) { const modal = document.getElementById(id); modal.style.display = 'flex'; requestAnimationFrame(() => modal.classList.add('show')); }
    function closeModal(id) { const modal = document.getElementById(id); modal.classList.remove('show'); setTimeout(() => modal.style.display = 'none', 300); }

    let userApiKey = '';
    function initApiKey() { const storedKey = localStorage.getItem('gemini_api_key'); if (storedKey) userApiKey = storedKey; else setTimeout(() => openSettings(), 500); }
    function openSettings() { document.getElementById('apiKeyInput').value = userApiKey; openModal('settingsModal'); }
    function closeSettings() { closeModal('settingsModal'); }
    function saveApiKey() { const input = document.getElementById('apiKeyInput').value.trim(); if (input) { localStorage.setItem('gemini_api_key', input); userApiKey = input; closeModal('settingsModal'); showToast("API Key 設定成功！"); } else { showToast("請輸入有效的 API Key", "error"); } }
    function confirmReset() { closeModal('settingsModal'); setTimeout(() => openModal('confirmModal'), 300); }
    function closeConfirm() { closeModal('confirmModal'); setTimeout(() => openSettings(), 300); }
    function executeReset() { localStorage.removeItem('gemini_api_key'); userApiKey = ''; closeModal('confirmModal'); showToast("API Key 已清除"); setTimeout(() => openSettings(), 1000); }

    const languages = [
        { name: '繁體中文', prompt: 'Traditional Chinese', speechCode: 'zh-TW' },
        { name: 'English', prompt: 'English', speechCode: 'en-US' },
        { name: '日本語', prompt: 'Japanese', speechCode: 'ja-JP' },
        { name: '한국어', prompt: 'Korean', speechCode: 'ko-KR' },
        { name: 'Français', prompt: 'French', speechCode: 'fr-FR' },
        { name: 'Español', prompt: 'Spanish', speechCode: 'es-ES' },
        { name: 'Deutsch', prompt: 'German', speechCode: 'de-DE' },
        { name: 'Tiếng Việt', prompt: 'Vietnamese', speechCode: 'vi-VN' },
        { name: 'ภาษาไทย', prompt: 'Thai', speechCode: 'th-TH' }
    ];
    let currentMode = 'text', recognition, isListening = false, activeMicSide = null, synth = window.speechSynthesis;

    window.onload = () => { initApiKey(); initLanguageSelects(); updateVoiceLabels(); checkSpeechSupport(); };

    function initLanguageSelects() {
        const textSource = document.getElementById('textSourceLang');
        const textTarget = document.getElementById('textTargetLang');
        languages.forEach((lang, index) => {
            let option = new Option(lang.name, index);
            textSource.add(option.cloneNode(true));
            textTarget.add(option.cloneNode(true));
        });
        textSource.selectedIndex = 0; textTarget.selectedIndex = 1; 
    }

    function checkSpeechSupport() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            showToast("瀏覽器不支援語音，請用 Chrome", "error"); document.getElementById('voiceModeBtn').disabled = true;
        } else {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition(); recognition.continuous = false; recognition.interimResults = true;
            recognition.onstart = () => { isListening = true; updateMicUI(true); };
            recognition.onresult = (event) => {
                let interim = '', final = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) final += event.results[i][0].transcript; else interim += event.results[i][0].transcript;
                }
                const targetBoxId = activeMicSide === 'top' ? 'topOriginalText' : 'bottomOriginalText';
                document.getElementById(targetBoxId).innerText = final || interim;
                if (final) { stopListening(); doVoiceTranslation(final, activeMicSide); }
            };
            recognition.onerror = (event) => { stopListening(); console.error(event.error); };
            recognition.onend = () => { stopListening(); };
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        document.getElementById('textModeBtn').classList.toggle('active', mode === 'text');
        document.getElementById('voiceModeBtn').classList.toggle('active', mode === 'voice');
        document.getElementById('textModeContainer').style.display = mode === 'text' ? 'flex' : 'none';
        document.getElementById('voiceMirroredContainer').style.display = mode === 'voice' ? 'flex' : 'none';
        if(mode === 'voice') updateVoiceLabels();
    }
    function updateVoiceLabels() {
        const sourceIndex = document.getElementById('textSourceLang').value;
        const targetIndex = document.getElementById('textTargetLang').value;
        document.getElementById('bottomLangLabel').innerText = languages[sourceIndex].name;
        document.getElementById('topLangLabel').innerText = languages[targetIndex].name;
    }

    // ==========================================
    // 關鍵修正：確保模型為 gemini-1.5-flash
    // ==========================================
    async function callGeminiAPI(text, sourceLangPrompt, targetLangPrompt) {
        if (!userApiKey) { showToast("請先設定 API Key", "error"); openSettings(); throw new Error("No API Key"); }
        
        // 確保這裡不是 gemini-pro，而是 gemini-1.5-flash
        const modelName = 'gemini-1.5-flash';

        const prompt = `
            You are a professional simultaneous interpreter. 
            Translate the following text from ${sourceLangPrompt} to ${targetLangPrompt}.
            Maintain the original tone. Only output the translated text directly. No explanations.
            Text: "${text}"
        `;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${userApiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error:", errorData);
                
                let msg = `Error ${response.status}`;
                if (errorData.error && errorData.error.message) {
                     msg += `: ${errorData.error.message}`;
                     if(response.status === 403) msg = "權限被拒 (403)。請檢查 API Key 是否限制了 Referrer？";
                }
                showToast("翻譯失敗", "error");
                // 這裡會明確顯示是哪個模型失敗
                return `[系統訊息] 模型 ${modelName} 失敗: ${msg}`;
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0].content) {
                return data.candidates[0].content.parts[0].text.trim();
            } else throw new Error("Format Error");
        } catch (error) {
            console.error(error); showToast("連線錯誤", "error"); return `[系統訊息] 連線失敗: ${error.message}`;
        }
    }

    async function doTextTranslation() {
        const input = document.getElementById('textInput'); const output = document.getElementById('textOutput');
        const btn = document.getElementById('textTranslateBtn'); const loading = document.getElementById('textLoading');
        if (!input.value.trim()) return;
        btn.disabled = true; loading.style.display = 'block'; output.value = '';
        const sourceIdx = document.getElementById('textSourceLang').value; const targetIdx = document.getElementById('textTargetLang').value;
        try { output.value = await callGeminiAPI(input.value, languages[sourceIdx].prompt, languages[targetIdx].prompt); } catch (e) { output.value = "錯誤"; } finally { btn.disabled = false; loading.style.display = 'none'; }
    }
    function swapTextLanguages() {
        const s = document.getElementById('textSourceLang'); const t = document.getElementById('textTargetLang');
        [s.value, t.value] = [t.value, s.value];
        const i = document.getElementById('textInput'); const o = document.getElementById('textOutput');
        if(o.value) { i.value = o.value; o.value = ''; }
    }
    function startListening(side) {
        if (isListening || !recognition) return;
        activeMicSide = side;
        const sIdx = document.getElementById('textSourceLang').value; const tIdx = document.getElementById('textTargetLang').value;
        recognition.lang = (side === 'top') ? languages[tIdx].speechCode : languages[sIdx].speechCode;
        document.getElementById(side + 'OriginalText').innerText = '...';
        document.getElementById((side === 'top' ? 'bottom' : 'top') + 'TranslatedText').innerText = '...';
        recognition.start();
    }
    function stopListening() { if (recognition) recognition.stop(); isListening = false; updateMicUI(false); }
    function updateMicUI(listening) {
        document.getElementById('topMicBtn').classList.toggle('listening', listening && activeMicSide === 'top');
        document.getElementById('bottomMicBtn').classList.toggle('listening', listening && activeMicSide === 'bottom');
    }
    async function doVoiceTranslation(text, side) {
        const sIdx = document.getElementById('textSourceLang').value; const tIdx = document.getElementById('textTargetLang').value;
        let sPrompt, tPrompt, outId, speechLang;
        if (side === 'top') { sPrompt = languages[tIdx].prompt; tPrompt = languages[sIdx].prompt; outId = 'bottomTranslatedText'; speechLang = languages[sIdx].speechCode; }
        else { sPrompt = languages[sIdx].prompt; tPrompt = languages[tIdx].prompt; outId = 'topTranslatedText'; speechLang = languages[tIdx].speechCode; }
        const result = await callGeminiAPI(text, sPrompt, tPrompt);
        document.getElementById(outId).innerText = result;
        if (!result.startsWith("[系統訊息]")) speakText(result, speechLang);
    }
    function speakText(text, langCode) {
        if (!synth) return; synth.cancel();
        const u = new SpeechSynthesisUtterance(text); u.lang = langCode;
        const v = synth.getVoices().find(v => v.lang === langCode && (v.name.includes('Google') || v.name.includes('Siri')));
        if (v) u.voice = v; synth.speak(u);
    }
    if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = () => {};
</script>
</body>
</html>