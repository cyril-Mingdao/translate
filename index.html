<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 智能翻譯機 (v7.0 自動偵測版)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* CSS 樣式維持不變，新增了模型選擇器的樣式 */
        :root { --primary-color: #4285F4; --secondary-color: #34A853; --danger-color: #d93025; --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333; --mirrored-bg-top: #e8f0fe; --mirrored-bg-bottom: #e6f4ea; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Roboto', Helvetica, Arial, sans-serif; background-color: var(--bg-color); margin: 0; color: var(--text-color); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .header-controls { position: fixed; top: 15px; right: 15px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 5px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; gap: 8px; backdrop-filter: blur(5px); }
        .ctrl-btn { background: none; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 14px; color: #555; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .ctrl-btn.active { background-color: var(--primary-color); color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; }
        .custom-window { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateY(20px); transition: transform 0.3s ease; }
        .modal-overlay.show .custom-window { transform: translateY(0); }
        .custom-window h3 { margin-top: 0; color: var(--primary-color); font-size: 1.3rem;}
        .input-group { position: relative; margin: 20px 0; }
        .custom-window input { width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; transition: border 0.3s; outline: none; background: #fafafa; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-primary, .btn-secondary, .btn-danger, .btn-warning { padding: 10px 20px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; flex: 1; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: #eee; color: #555; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-warning { background: #fbbc04; color: #333; }
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 100%; align-items: center; }
        .toast { background: rgba(40, 40, 40, 0.95); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #d93025; }
        #textModeContainer { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        .text-card { background-color: var(--card-bg); width: 100%; max-width: 600px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        h2.app-title { text-align: center; color: var(--primary-color); margin-bottom: 20px; font-size: 1.5rem;}
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        select { flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #fff; appearance: none; cursor: pointer;}
        .swap-btn { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--primary-color); padding: 10px; border-radius: 50%; transition: background 0.2s; }
        .swap-btn:hover { background: #e8f0fe; }
        textarea { width: 100%; height: 120px; padding: 15px; border-radius: 10px; border: 1px solid #ddd; font-size: 18px; resize: none; font-family: inherit; margin-bottom: 15px; transition: border 0.3s; }
        textarea:focus { outline: none; border-color: var(--primary-color); }
        .output-box { background-color: #f8f9fa; color: #444; border: 1px solid #eee;}
        button.translate-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.2s; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); }
        button.translate-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        .loading-text { display: none; text-align: center; margin-top: 15px; color: #666; font-size: 14px; }
        #voiceMirroredContainer { display: none; flex-direction: column; height: 100%; width: 100%; background: #fff; }
        .half-screen { flex: 1; display: flex; flex-direction: column; padding: 20px; overflow-y: auto; position: relative; }
        .top-half { background-color: var(--mirrored-bg-top); transform: rotate(180deg); border-bottom: 1px solid #ccdcee; }
        .bottom-half { background-color: var(--mirrored-bg-bottom); border-top: 1px solid #cce5d0; }
        .lang-label { font-weight: bold; color: #555; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 15px; align-self: flex-start; }
        .speech-bubble { background: white; padding: 15px; border-radius: 18px; margin-bottom: 10px; font-size: 18px; min-height: 60px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); word-break: break-word; line-height: 1.4; border: 1px solid rgba(0,0,0,0.05); }
        .speech-bubble.translated { background: #fff; color: var(--primary-color); border-left: 4px solid var(--primary-color); }
        .bottom-half .speech-bubble.translated { border-color: var(--secondary-color); color: var(--secondary-color); }
        .mic-controls { margin-top: auto; display: flex; justify-content: center; padding-top: 15px; }
        .mic-btn { width: 70px; height: 70px; border-radius: 50%; border: none; background-color: var(--primary-color); color: white; font-size: 28px; cursor: pointer; box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4); transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .bottom-half .mic-btn { background-color: var(--secondary-color); box-shadow: 0 6px 15px rgba(52, 168, 83, 0.4); }
        .mic-btn.listening { animation: pulse 1.5s infinite; background-color: var(--danger-color) !important; box-shadow: 0 6px 15px rgba(217, 48, 37, 0.4); }
        
        /* v7.0 新增：模型選擇器樣式 */
        #model-selector-container {
            margin-bottom: 10px; padding: 10px; background: #eef2f8; border-radius: 10px; border: 1px dashed #ccc; font-size: 14px; color: #555;
            display: flex; align-items: center; justify-content: space-between;
        }
        #current-model-select {
            padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px; max-width: 200px;
        }
        
        @media (max-width: 480px) { .text-card { padding: 20px; width: 95%; margin-top: 50px; } .mic-btn { width: 64px; height: 64px; } .custom-window { width: 85%; } }
    </style>
</head>
<body>

    <div class="header-controls">
        <button class="ctrl-btn active" onclick="switchMode('text')" id="textModeBtn"><i class="fas fa-keyboard"></i> 文字</button>
        <button class="ctrl-btn" onclick="switchMode('voice')" id="voiceModeBtn"><i class="fas fa-microphone-alt"></i> 語音</button>
        <button class="ctrl-btn" onclick="openSettings()" title="設定"><i class="fas fa-cog"></i></button>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="custom-window">
            <h3><i class="fas fa-key"></i> 設定 API Key</h3>
            <p>請輸入 Google Gemini API Key。</p>
            <div class="input-group">
                <input type="password" id="apiKeyInput" placeholder="請貼上 API Key">
            </div>
            <div class="btn-group">
                <button class="btn-secondary" onclick="closeSettings()">取消</button>
                <button class="btn-primary" onclick="saveApiKey()">儲存設定</button>
            </div>
            <div style="margin-top:10px;">
                <button class="btn-warning" style="width:100%" onclick="fetchAndAutoSelectModel()"><i class="fas fa-sync-alt"></i> 重新偵測可用模型</button>
            </div>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
                <button class="btn-danger" style="font-size:14px; padding:8px;" onclick="executeReset()"><i class="fas fa-trash"></i> 清除 Key</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <div id="textModeContainer">
        <div class="text-card">
            <h2 class="app-title"><i class="fas fa-robot"></i> AI 智能翻譯機 (v7.0)</h2>
            
            <div id="model-selector-container">
                <span><i class="fas fa-microchip"></i> 使用模型:</span>
                <select id="current-model-select" onchange="manualSelectModel()">
                    <option value="">正在偵測...</option>
                </select>
            </div>

            <div class="controls">
                <select id="textSourceLang"></select>
                <button class="swap-btn" onclick="swapTextLanguages()"><i class="fas fa-exchange-alt"></i></button>
                <select id="textTargetLang"></select>
            </div>
            <textarea id="textInput" placeholder="請輸入要翻譯的文字..."></textarea>
            <textarea id="textOutput" class="output-box" placeholder="翻譯結果..." readonly></textarea>
            <button id="textTranslateBtn" class="translate-btn" onclick="doTextTranslation()">開始翻譯</button>
            <div id="textLoading" class="loading-text"><i class="fas fa-spinner fa-spin"></i> Gemini 正在思考中...</div>
        </div>
    </div>

    <div id="voiceMirroredContainer">
        <div class="half-screen top-half">
            <div class="lang-label"><i class="fas fa-user-friends"></i> 對方 (<span id="topLangLabel"></span>)</div>
            <div id="topOriginalText" class="speech-bubble" placeholder="聆聽中..."></div>
            <div id="topTranslatedText" class="speech-bubble translated" placeholder="翻譯結果..."></div>
            <div class="mic-controls">
                <button id="topMicBtn" class="mic-btn" onmousedown="startListening('top')" onmouseup="stopListening()" ontouchstart="startListening('top')" ontouchend="stopListening()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
        <div class="half-screen bottom-half">
            <div class="lang-label"><i class="fas fa-user"></i> 我方 (<span id="bottomLangLabel"></span>)</div>
            <div id="bottomOriginalText" class="speech-bubble" placeholder="聆聽中..."></div>
            <div id="bottomTranslatedText" class="speech-bubble translated" placeholder="翻譯結果..."></div>
            <div class="mic-controls">
                <button id="bottomMicBtn" class="mic-btn" onmousedown="startListening('bottom')" onmouseup="stopListening()" ontouchstart="startListening('bottom')" ontouchend="stopListening()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
    // ===== 全域變數 =====
    let userApiKey = '';
    let selectedModel = ''; // 當前使用的模型
    const languages=[{name:'繁體中文',prompt:'Traditional Chinese',speechCode:'zh-TW'},{name:'English',prompt:'English',speechCode:'en-US'},{name:'日本語',prompt:'Japanese',speechCode:'ja-JP'},{name:'한국어',prompt:'Korean',speechCode:'ko-KR'},{name:'Français',prompt:'French',speechCode:'fr-FR'},{name:'Español',prompt:'Spanish',speechCode:'es-ES'},{name:'Deutsch',prompt:'German',speechCode:'de-DE'},{name:'Tiếng Việt',prompt:'Vietnamese',speechCode:'vi-VN'},{name:'ภาษาไทย',prompt:'Thai',speechCode:'th-TH'}];
    let currentMode='text',recognition,isListening=false,activeMicSide=null,synth=window.speechSynthesis;

    // ===== UI 工具 =====
    function showToast(m,t='normal'){const c=document.getElementById('toast-container'),d=document.createElement('div');d.className='toast'+(t==='error'?' error':'');d.innerText=m;c.appendChild(d);requestAnimationFrame(()=>d.classList.add('show'));setTimeout(()=>{d.classList.remove('show');setTimeout(()=>d.remove(),300)},4000)}
    function openModal(id){const m=document.getElementById(id);m.style.display='flex';requestAnimationFrame(()=>m.classList.add('show'));}
    function closeModal(id){const m=document.getElementById(id);m.classList.remove('show');setTimeout(()=>m.style.display='none',300);}

    // ===== Key 管理 =====
    function initApiKey(){
        const k=localStorage.getItem('gemini_api_key');
        if(k) { 
            userApiKey=k; 
            // 有 Key 時，自動偵測一次模型
            setTimeout(()=>fetchAndAutoSelectModel(), 1000);
        } else { 
            setTimeout(()=>openSettings(),500); 
        }
    }
    function openSettings(){document.getElementById('apiKeyInput').value=userApiKey;openModal('settingsModal');}
    function closeSettings(){closeModal('settingsModal');}
    function saveApiKey(){const k=document.getElementById('apiKeyInput').value.trim();if(k){localStorage.setItem('gemini_api_key',k);userApiKey=k;closeModal('settingsModal');showToast("API Key 設定成功"); fetchAndAutoSelectModel();}else{showToast("請輸入 Key","error");}}
    function executeReset(){localStorage.removeItem('gemini_api_key');userApiKey='';closeModal('settingsModal');showToast("Key 已清除");setTimeout(()=>openSettings(),1000);}

    // ===== v7.0 核心：自動模型偵測與選擇 =====
    async function fetchAndAutoSelectModel() {
        if (!userApiKey) return;
        const select = document.getElementById('current-model-select');
        select.innerHTML = '<option>偵測中...</option>';
        select.disabled = true;

        try {
            // 1. 問 Google 你的 Key 到底有哪些模型
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${userApiKey}`);
            const data = await res.json();

            if (!res.ok || !data.models) {
                // 如果連查詢都失敗，代表 API Key 本身無效或服務沒開
                select.innerHTML = '<option value="">(Key 無效或服務未開)</option>';
                alert("無法取得模型列表！\n請檢查您的 Key 權限，或是否啟用了 Generative Language API。");
                return;
            }

            // 2. 過濾出支援 generateContent 的模型
            const availableModels = data.models
                .filter(m => m.supportedGenerationMethods.includes('generateContent'))
                .map(m => m.name.replace('models/', '')); // 去掉前綴

            if (availableModels.length === 0) {
                select.innerHTML = '<option value="">(無可用模型)</option>';
                alert("您的 Key 權限下找不到任何可用模型！請建立新 Key。");
                return;
            }

            // 3. 填入下拉選單
            select.innerHTML = '';
            // 優先排序策略：Flash > Pro > 其他
            availableModels.sort((a, b) => {
                if (a.includes('flash') && !b.includes('flash')) return -1;
                if (!a.includes('flash') && b.includes('flash')) return 1;
                return 0;
            });

            availableModels.forEach(model => {
                const opt = document.createElement('option');
                opt.value = model;
                opt.innerText = model;
                select.appendChild(opt);
            });

            select.disabled = false;
            
            // 4. 自動選擇第一個 (通常是最快的 Flash)
            selectedModel = availableModels[0];
            select.value = selectedModel;
            showToast(`已自動選擇: ${selectedModel}`);
            console.log("Auto selected:", selectedModel);

        } catch (e) {
            console.error(e);
            select.innerHTML = '<option value="gemini-1.5-flash">預設(Gemini 1.5 Flash)</option>';
            selectedModel = 'gemini-1.5-flash'; // 網路錯誤時的保底
            showToast("偵測失敗，使用預設值", "error");
        }
    }

    function manualSelectModel() {
        const select = document.getElementById('current-model-select');
        selectedModel = select.value;
        showToast(`已切換模型為: ${selectedModel}`);
    }

    // ===== 翻譯核心 (使用動態選擇的模型) =====
    async function callGeminiAPI(text, sP, tP) {
        if(!userApiKey){showToast("請設定 Key","error");openSettings();throw new Error("No Key");}
        if(!selectedModel) {
            // 如果還沒選好模型，嘗試再抓一次，或用保底
            selectedModel = 'gemini-1.5-flash'; 
        }

        const prompt=`You are a professional translator. Translate from ${sP} to ${tP}. Only output the translated text. Text: "${text}"`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel}:generateContent?key=${userApiKey}`,{
                method:'POST',headers:{'Content-Type':'application/json'},
                body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
            });
            
            if(res.ok) {
                const data = await res.json();
                if(data.candidates) return data.candidates[0].content.parts[0].text.trim();
            } 
            
            // 錯誤處理
            const err = await res.json();
            let msg = err.error ? err.error.message : "未知錯誤";

            // 如果遇到 Quota 0，建議用戶切換
            if (msg.includes("Quota exceeded") || msg.includes("limit: 0")) {
                alert(`模型 ${selectedModel} 額度不足 (Quota: 0)！\n請嘗試在下拉選單切換其他模型 (例如 gemini-pro 或 1.0)。`);
            } else if (msg.includes("not found")) {
                alert(`模型 ${selectedModel} 權限不足或不存在！\n請嘗試切換其他模型。`);
            }

            showToast("翻譯失敗", "error");
            return `[系統訊息] 錯誤: ${msg}`;
                
        } catch(e) {
            console.error(e);
            showToast("連線錯誤", "error");
            return `[連線失敗] ${e.message}`;
        }
    }

    // ===== 初始化與介面邏輯 (保持不變) =====
    window.onload=()=>{initApiKey();initLanguageSelects();updateVoiceLabels();checkSpeechSupport();};
    function initLanguageSelects(){const s=document.getElementById('textSourceLang'),t=document.getElementById('textTargetLang');languages.forEach((l,i)=>{s.add(new Option(l.name,i));t.add(new Option(l.name,i))});s.selectedIndex=0;t.selectedIndex=1;}
    function checkSpeechSupport(){if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){showToast("請用 Chrome","error");document.getElementById('voiceModeBtn').disabled=true;}else{const SR=window.SpeechRecognition||window.webkitSpeechRecognition;recognition=new SR();recognition.continuous=false;recognition.interimResults=true;recognition.onstart=()=>{isListening=true;updateMicUI(true)};recognition.onresult=(e)=>{let f='';for(let i=e.resultIndex;i<e.results.length;++i)if(e.results[i].isFinal)f+=e.results[i][0].transcript;const id=activeMicSide==='top'?'topOriginalText':'bottomOriginalText';document.getElementById(id).innerText=f||'...';if(f){stopListening();doVoiceTranslation(f,activeMicSide)}};recognition.onerror=(e)=>{stopListening();console.error(e)};recognition.onend=()=>{stopListening()}}}
    function switchMode(m){currentMode=m;document.getElementById('textModeBtn').classList.toggle('active',m==='text');document.getElementById('voiceModeBtn').classList.toggle('active',m==='voice');document.getElementById('textModeContainer').style.display=m==='text'?'flex':'none';document.getElementById('voiceMirroredContainer').style.display=m==='voice'?'flex':'none';if(m==='voice')updateVoiceLabels();}
    function updateVoiceLabels(){const s=document.getElementById('textSourceLang').value,t=document.getElementById('textTargetLang').value;document.getElementById('bottomLangLabel').innerText=languages[s].name;document.getElementById('topLangLabel').innerText=languages[t].name;}
    async function doTextTranslation(){const i=document.getElementById('textInput'),o=document.getElementById('textOutput'),b=document.getElementById('textTranslateBtn'),l=document.getElementById('textLoading');if(!i.value.trim())return;b.disabled=true;l.style.display='block';o.value='';const s=document.getElementById('textSourceLang').value,t=document.getElementById('textTargetLang').value;try{o.value=await callGeminiAPI(i.value,languages[s].prompt,languages[t].prompt)}catch(e){o.value="Error"}finally{b.disabled=false;l.style.display='none'}}
    function swapTextLanguages(){const s=document.getElementById('textSourceLang'),t=document.getElementById('textTargetLang');[s.value,t.value]=[t.value,s.value];const i=document.getElementById('textInput'),o=document.getElementById('textOutput');if(o.value){i.value=o.value;o.value=''}}
    function startListening(s){if(isListening||!recognition)return;activeMicSide=s;const sI=document.getElementById('textSourceLang').value,tI=document.getElementById('textTargetLang').value;recognition.lang=s==='top'?languages[tI].speechCode:languages[sI].speechCode;document.getElementById(s+'OriginalText').innerText='...';document.getElementById((s==='top'?'bottom':'top')+'TranslatedText').innerText='...';recognition.start()}
    function stopListening(){if(recognition)recognition.stop();isListening=false;updateMicUI(false)}
    function updateMicUI(l){document.getElementById('topMicBtn').classList.toggle('listening',l&&activeMicSide==='top');document.getElementById('bottomMicBtn').classList.toggle('listening',l&&activeMicSide==='bottom')}
    async function doVoiceTranslation(t,s){const sI=document.getElementById('textSourceLang').value,tI=document.getElementById('textTargetLang').value;let sP,tP,out,lang;if(s==='top'){sP=languages[tI].prompt;tP=languages[sI].prompt;out='bottomTranslatedText';lang=languages[sI].speechCode}else{sP=languages[sI].prompt;tP=languages[tI].prompt;out='topTranslatedText';lang=languages[tI].speechCode}const r=await callGeminiAPI(t,sP,tP);document.getElementById(out).innerText=r;if(!r.startsWith("["))speakText(r,lang)}
    function speakText(t,l){if(!synth)return;synth.cancel();const u=new SpeechSynthesisUtterance(t);u.lang=l;const v=synth.getVoices().find(v=>v.lang===l&&(v.name.includes('Google')||v.name.includes('Siri')));if(v)u.voice=v;synth.speak(u)}if(speechSynthesis.onvoiceschanged!==undefined)speechSynthesis.onvoiceschanged=()=>{};
</script>
</body>
</html>