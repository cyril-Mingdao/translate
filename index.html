<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Êô∫ËÉΩÁøªË≠ØÊ©ü (v46.0)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåê</text></svg>">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* ================= ÂÖ®ÂüüË®≠ÂÆö ================= */
        :root { --primary-color: #4285F4; --secondary-color: #34A853; --danger-color: #d93025; --bg-color: #f0f2f5; --card-bg: #ffffff; --text-color: #333; --mirrored-bg-top: #e8f0fe; --mirrored-bg-bottom: #e6f4ea; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Roboto', Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; color: var(--text-color); 
            height: 100vh; overflow: hidden; 
            display: flex; flex-direction: column; 
            -webkit-user-select: none; 
            user-select: none; 
            -webkit-touch-callout: none;
        }

        /* ================= È†≠ÈÉ®ÊéßÂà∂ÊåâÈàï ================= */
        .header-controls { 
            position: fixed; z-index: 2000; background: rgba(255,255,255,0.95); padding: 5px; 
            border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; gap: 8px; 
            backdrop-filter: blur(5px); transition: all 0.1s ease; 
        }
        .ctrl-btn { background: none; border: none; padding: 8px 15px; border-radius: 15px; cursor: pointer; font-size: 14px; color: #555; transition: all 0.2s; display: flex; align-items: center; gap: 5px; }
        .ctrl-btn.active { background-color: var(--primary-color); color: white; font-weight: bold; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3); }

        @media (max-width: 480px) {
            body:not(.voice-mode-portrait) .header-controls { top: 15px; left: 50%; right: auto; transform: translateX(-50%); white-space: nowrap; }
        }
        @media (min-width: 481px) { .header-controls { top: 15px; right: 15px; } }

        body.voice-mode-portrait .header-controls { 
            top: calc(50% + 20px); 
            right: 10px; left: auto; transform: none; 
            background: transparent; border: none; box-shadow: none; padding: 0; gap: 8px; 
        }
        body.voice-mode-portrait .ctrl-btn span { display: none; }
        body.voice-mode-portrait .ctrl-btn { 
            background: rgba(255,255,255,0.9); padding: 0; width: 36px; height: 36px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 16px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15); border: 1px solid rgba(0,0,0,0.05);
        }
        body.voice-mode-portrait .ctrl-btn.active { background-color: var(--primary-color); color: white; box-shadow: 0 2px 8px rgba(66, 133, 244, 0.4); }

        /* ================= ÂΩàÁ™óËàáÊèêÁ§∫ ================= */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { opacity: 1; }
        .custom-window { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateY(20px); transition: transform 0.3s ease; }
        .modal-overlay.show .custom-window { transform: translateY(0); }
        .custom-window h3 { margin-top: 0; color: var(--primary-color); font-size: 1.3rem;}
        .input-group { position: relative; margin: 20px 0; }
        .custom-window input { 
            width: 100%; padding: 12px 15px; border: 2px solid #eee; border-radius: 10px; font-size: 16px; transition: border 0.3s; outline: none; background: #fafafa; 
            -webkit-user-select: auto; user-select: auto; 
        }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .btn-primary, .btn-secondary, .btn-danger, .btn-warning { padding: 10px 20px; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; flex: 1; }
        .btn-primary { background: var(--primary-color); color: white; }
        .btn-secondary { background: #eee; color: #555; }
        .btn-danger { background: var(--danger-color); color: white; }
        .btn-warning { background: #fbbc04; color: #333; }
        #toast-container { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 4000; display: flex; flex-direction: column; gap: 10px; pointer-events: none; width: 90%; align-items: center; }
        .toast { background: rgba(40, 40, 40, 0.95); color: white; padding: 12px 24px; border-radius: 50px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; transform: translateY(20px); transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; word-break: break-word; pointer-events: auto; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.error { background: #d93025; }

        /* ================= ÊñáÂ≠óÊ®°Âºè‰ªãÈù¢ ================= */
        #textModeContainer { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100%; padding: 20px; overflow-y: auto; }
        
        .text-card { 
            background-color: var(--card-bg); 
            width: 100%; 
            max-width: 1200px; 
            padding: 25px; 
            border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.08); 
            margin: 0 auto;
        }
        
        h2.app-title { text-align: center; color: var(--primary-color); margin-bottom: 5px; font-size: 1.5rem;}
        .app-subtitle { text-align: center; color: #000; margin-bottom: 20px; font-size: 0.75rem; font-weight: normal; }
        .controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        
        select { 
            flex: 1; padding: 12px; border-radius: 10px; border: 1px solid #ddd; font-size: 16px; background: #fff; appearance: none; cursor: pointer; width: 0; min-width: 0; text-overflow: ellipsis; 
            -webkit-user-select: none; user-select: none; 
        }
        
        .swap-btn { background: none; border: none; cursor: pointer; font-size: 20px; color: var(--primary-color); padding: 10px; border-radius: 50%; transition: background 0.2s; flex-shrink: 0; }
        .swap-btn:hover { background: #e8f0fe; }
        
        .input-wrapper { position: relative; width: 100%; margin-bottom: 15px; }
        textarea { 
            width: 100%; height: 120px; padding: 15px; padding-right: 45px; border-radius: 10px; border: 1px solid #ddd; font-size: 18px; resize: none; font-family: inherit; transition: border 0.3s; 
            -webkit-user-select: auto; user-select: auto;
        }
        textarea:focus { outline: none; border-color: var(--primary-color); }
        
        .clear-btn {
            position: absolute; top: 10px; right: 10px; background: rgba(240,240,240,0.9);
            border: none; border-radius: 50%; width: 32px; height: 32px; color: #666;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; transition: all 0.2s; z-index: 100; pointer-events: auto;
        }
        .clear-btn:hover { background: #feebeb; color: var(--danger-color); transform: scale(1.1); }

        .output-box { background-color: #f8f9fa; color: #444; border: 1px solid #eee;}
        button.translate-btn { width: 100%; padding: 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.2s; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.3); }
        button.translate-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        .loading-text { display: none; text-align: center; margin-top: 15px; color: #666; font-size: 14px; }
        #model-selector-container { margin-bottom: 10px; padding: 10px; background: #eef2f8; border-radius: 10px; border: 1px dashed #ccc; font-size: 14px; color: #555; display: flex; align-items: center; justify-content: space-between; }
        #current-model-select { padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 13px; max-width: 200px; }
        .output-wrapper { position: relative; }
        .play-btn { position: absolute; bottom: 25px; right: 10px; background: none; border: none; color: var(--primary-color); font-size: 20px; cursor: pointer; padding: 5px; opacity: 0.6; transition: opacity 0.2s; }
        .play-btn:hover { opacity: 1; transform: scale(1.1); }

        .download-btn { 
            position: absolute; bottom: 25px; right: 50px; 
            background: none; border: none; color: #555; 
            font-size: 18px; cursor: pointer; padding: 5px; 
            opacity: 0.6; transition: opacity 0.2s; 
        }
        .download-btn:hover { opacity: 1; transform: scale(1.1); color: var(--primary-color); }

        /* ================= Ë™ûÈü≥Èè°ÂÉèÊ®°Âºè ================= */
        #voiceMirroredContainer { display: none; flex-direction: column; height: 100%; width: 100%; background: #fff; overflow: hidden; }
        .half-screen { display: flex; flex-direction: column; padding: 20px; overflow-y: hidden; position: relative; }
        
        .top-half { 
            background-color: var(--mirrored-bg-top); 
            transform: rotate(180deg); 
            border-bottom: 1px solid #ccdcee; 
            height: 50%; 
            flex: none; 
            min-height: 20%; max-height: 80%; 
        }
        .bottom-half { 
            background-color: var(--mirrored-bg-bottom); 
            border-top: 1px solid #cce5d0; 
            flex: 1; 
        }
        
        #splitter {
            height: 20px; width: 100%; background: transparent; cursor: row-resize;
            display: flex; align-items: center; justify-content: center; z-index: 100;
            flex-shrink: 0; margin-top: -10px; margin-bottom: -10px;
        }
        #splitter::after { content: ''; width: 40px; height: 4px; background-color: #ccc; border-radius: 2px; transition: background-color 0.2s; }
        #splitter:active::after { background-color: var(--primary-color); }

        .lang-select-container { font-weight: bold; color: #555; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.6); padding: 5px 10px; border-radius: 15px; align-self: flex-start; }
        .voice-lang-select { border: none; background: transparent; font-size: 16px; font-weight: bold; color: #333; cursor: pointer; appearance: none; border-bottom: 1px dashed #999; width: auto; min-width: auto; flex: none; }
        
        .bubble-wrapper { position: relative; margin-bottom: 10px; }
        .speech-bubble { 
            background: white; padding: 15px; border-radius: 18px; font-size: 18px; 
            min-height: 50px; height: auto; max-height: 40vh; overflow-y: auto; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); word-break: break-word; line-height: 1.4; border: 1px solid rgba(0,0,0,0.05);
            cursor: pointer; 
            -webkit-user-select: text; 
            user-select: text;
        }
        .speech-bubble:active { transform: scale(0.98); background: #f0f0f0; transition: transform 0.1s; } 

        .speech-bubble.translated { background: #fff; color: var(--primary-color); border-left: 4px solid var(--primary-color); }
        .bottom-half .speech-bubble.translated { border-color: var(--secondary-color); color: var(--secondary-color); }
        
        .copy-btn {
            position: absolute; bottom: 8px; right: 8px; background: rgba(255,255,255,0.8);
            border: none; border-radius: 50%; width: 30px; height: 30px; color: #888;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 14px; transition: all 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .copy-btn:hover { color: var(--primary-color); background: #fff; transform: scale(1.1); }

        .mic-btn { 
            position: absolute; width: 75px; height: 75px; border-radius: 50%; border: none; 
            background-color: var(--primary-color); color: white; font-size: 32px; 
            cursor: grab; box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4); 
            transition: transform 0.2s, background-color 0.2s; 
            display: flex; align-items: center; justify-content: center; z-index: 50;
            left: 50%; transform: translateX(-50%); 
            touch-action: none; 
        }
        .mic-btn:active { cursor: grabbing; }
        
        #topMicBtn { top: 220px; bottom: auto; }
        #bottomMicBtn { top: 220px; bottom: auto; background-color: var(--secondary-color); box-shadow: 0 6px 20px rgba(52, 168, 83, 0.4); }
        
        .mic-btn.listening { animation: pulse 1.5s infinite; background-color: var(--danger-color) !important; box-shadow: 0 6px 20px rgba(217, 48, 37, 0.4); }
        @keyframes pulse { 0% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.1); } 100% { transform: translateX(-50%) scale(1); } }

        @media (max-width: 480px) { 
            .text-card { padding: 20px; width: 95%; margin-top: 50px; } 
            .custom-window { width: 85%; } 
            .half-screen { padding: 15px; }
        }
    </style>
</head>
<body oncontextmenu="return false;">
    <div class="header-controls" id="headerControls">
        <button class="ctrl-btn active" onclick="switchMode('text')" id="textModeBtn"><span>ÊñáÂ≠ó</span><i class="fas fa-keyboard"></i></button>
        <button class="ctrl-btn" onclick="switchMode('voice')" id="voiceModeBtn"><span>Ë™ûÈü≥</span><i class="fas fa-microphone-alt"></i></button>
        <button class="ctrl-btn" onclick="openSettings()" title="Ë®≠ÂÆö"><span>Ë®≠ÂÆö</span><i class="fas fa-cog"></i></button>
    </div>

    <div id="settingsModal" class="modal-overlay">
        <div class="custom-window">
            <h3><i class="fas fa-key"></i> Ë®≠ÂÆö API Key</h3>
            <p>Ë´ãËº∏ÂÖ• Google Gemini API Key„ÄÇ</p>
            <div class="input-group"><input type="password" id="apiKeyInput" placeholder="Ë´ãË≤º‰∏ä API Key"></div>
            <div class="btn-group">
                <button class="btn-secondary" onclick="closeSettings()">ÂèñÊ∂à</button>
                <button class="btn-primary" onclick="saveApiKey()">ÂÑ≤Â≠òË®≠ÂÆö</button>
            </div>
            <div style="margin-top:10px;"><button class="btn-warning" style="width:100%" onclick="fetchAndAutoSelectModel()"><i class="fas fa-sync-alt"></i> ÈáçÊñ∞ÂÅµÊ∏¨ÂèØÁî®Ê®°Âûã</button></div>
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:10px;"><button class="btn-danger" style="font-size:14px; padding:8px;" onclick="executeReset()"><i class="fas fa-trash"></i> Ê∏ÖÈô§ Key</button></div>
        </div>
    </div>
    <div id="toast-container"></div>

    <div id="textModeContainer">
        <div class="text-card">
            <h2 class="app-title"><i class="fas fa-robot"></i> AI Êô∫ËÉΩÁøªË≠ØÊ©ü (v46.0)</h2>
            <div class="app-subtitle">Ë©πÂÆóÈæç Ë£Ω‰Ωú</div>
            <div id="model-selector-container"><span><i class="fas fa-microchip"></i> ‰ΩøÁî®Ê®°Âûã:</span><select id="current-model-select" onchange="manualSelectModel()"><option value="">Ê≠£Âú®ÂÅµÊ∏¨...</option></select></div>
            <div class="controls"><select id="textSourceLang"></select><button class="swap-btn" onclick="swapTextLanguages()"><i class="fas fa-exchange-alt"></i></button><select id="textTargetLang"></select></div>
            
            <div class="input-wrapper">
                <textarea id="textInput" placeholder="Ë´ãËº∏ÂÖ•Ë¶ÅÁøªË≠ØÁöÑÊñáÂ≠ó..."></textarea>
                <button class="clear-btn" onclick="clearTextInput()" title="Ê∏ÖÁ©∫ÊñáÂ≠ó"><i class="fas fa-trash-alt"></i></button>
            </div>

            <div class="output-wrapper">
                <textarea id="textOutput" class="output-box" placeholder="ÁøªË≠ØÁµêÊûú..." readonly></textarea>
                <button class="download-btn" onclick="downloadTextAudio()" title="‰∏ãËºâÈü≥Ê™î"><i class="fas fa-download"></i></button>
                <button class="play-btn" onclick="playTextTranslation()" title="ÊúóËÆÄÁøªË≠ØÁµêÊûú"><i class="fas fa-volume-up"></i></button>
            </div>
            <button id="textTranslateBtn" class="translate-btn" onclick="doTextTranslation()">ÈñãÂßãÁøªË≠Ø</button>
            <div id="textLoading" class="loading-text"><i class="fas fa-spinner fa-spin"></i> Gemini Ê≠£Âú®ÊÄùËÄÉ‰∏≠...</div>
        </div>
    </div>

    <div id="voiceMirroredContainer">
        <div class="half-screen top-half" id="topHalf">
            <button id="topMicBtn" class="mic-btn"><i class="fas fa-microphone"></i></button>
            <div class="lang-select-container"><i class="fas fa-user-friends"></i> Â∞çÊñπ: <select id="voiceTopLang" class="voice-lang-select" onchange="syncLanguages('voice')"></select></div>
            <div class="bubble-wrapper">
                <div id="topOriginalText" class="speech-bubble" placeholder="ËÅÜËÅΩ‰∏≠..."></div>
                <button class="copy-btn" onclick="copyToClipboard('topOriginalText')" title="Ë§áË£ΩÊñáÂ≠ó"><i class="far fa-copy"></i></button>
            </div>
            <div class="bubble-wrapper">
                <div id="topTranslatedText" class="speech-bubble translated" placeholder="ÁøªË≠ØÁµêÊûú..."></div>
                <button class="copy-btn" onclick="copyToClipboard('topTranslatedText')" title="Ë§áË£ΩÊñáÂ≠ó"><i class="far fa-copy"></i></button>
            </div>
        </div>
        <div id="splitter"></div>
        <div class="half-screen bottom-half">
            <button id="bottomMicBtn" class="mic-btn"><i class="fas fa-microphone"></i></button>
            <div class="lang-select-container"><i class="fas fa-user"></i> ÊàëÊñπ: <select id="voiceBottomLang" class="voice-lang-select" onchange="syncLanguages('voice')"></select></div>
            <div class="bubble-wrapper">
                <div id="bottomOriginalText" class="speech-bubble" placeholder="ËÅÜËÅΩ‰∏≠..."></div>
                <button class="copy-btn" onclick="copyToClipboard('bottomOriginalText')" title="Ë§áË£ΩÊñáÂ≠ó"><i class="far fa-copy"></i></button>
            </div>
            <div class="bubble-wrapper">
                <div id="bottomTranslatedText" class="speech-bubble translated" placeholder="ÁøªË≠ØÁµêÊûú..."></div>
                <button class="copy-btn" onclick="copyToClipboard('bottomTranslatedText')" title="Ë§áË£ΩÊñáÂ≠ó"><i class="far fa-copy"></i></button>
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<script>
    let userApiKey = ''; let selectedModel = ''; 
    const languages=[
        {name:'ÁπÅÈ´î‰∏≠Êñá',prompt:'Traditional Chinese',speechCode:'zh-TW'},
        {name:'English (Ëã±Ë™û)',prompt:'English',speechCode:'en-US'},
        {name:'Êó•Êú¨Ë™û (Êó•Ë™û)',prompt:'Japanese',speechCode:'ja-JP'},
        {name:'ÌïúÍµ≠Ïñ¥ (ÈüìË™û)',prompt:'Korean',speechCode:'ko-KR'},
        {name:'Fran√ßais (Ê≥ïË™û)',prompt:'French',speechCode:'fr-FR'},
        {name:'Espa√±ol (Ë•øÁè≠ÁâôË™û)',prompt:'Spanish',speechCode:'es-ES'},
        {name:'Deutsch (Âæ∑Ë™û)',prompt:'German',speechCode:'de-DE'},
        {name:'Ti·∫øng Vi·ªát (Ë∂äÂçóË™û)',prompt:'Vietnamese',speechCode:'vi-VN'},
        {name:'‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (Ê≥∞Ë™û)',prompt:'Thai',speechCode:'th-TH'},
        {name:'Bahasa Melayu (È¶¨‰æÜË™û)',prompt:'Malay',speechCode:'ms-MY'},
        {name:'Bahasa Indonesia (Âç∞Â∞ºË™û)',prompt:'Indonesian',speechCode:'id-ID'},
        {name:'–†—É—Å—Å–∫–∏–π (‰øÑË™û)',prompt:'Russian',speechCode:'ru-RU'},
        {name:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (ÈòøÊãâ‰ºØË™û)',prompt:'Arabic',speechCode:'ar-SA'}
    ];
    let currentMode='text',recognition,isListening=false,activeMicSide=null,synth=window.speechSynthesis;
    let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

    function showToast(m,t='normal'){
        const c=document.getElementById('toast-container'),d=document.createElement('div');
        d.className='toast'+(t==='error'?' error':'');
        d.innerHTML=m;
        c.appendChild(d);requestAnimationFrame(()=>d.classList.add('show'));setTimeout(()=>{d.classList.remove('show');setTimeout(()=>d.remove(),300)},6000);
    }
    function openModal(id){const m=document.getElementById(id);m.style.display='flex';requestAnimationFrame(()=>m.classList.add('show'));}
    function closeModal(id){const m=document.getElementById(id);m.classList.remove('show');setTimeout(()=>m.style.display='none',300);}

    function initApiKey(){const k=localStorage.getItem('gemini_api_key');if(k){userApiKey=k;setTimeout(()=>fetchAndAutoSelectModel(), 1000);}else{setTimeout(()=>openSettings(),500);}}
    function openSettings(){document.getElementById('apiKeyInput').value=userApiKey;openModal('settingsModal');}
    function closeSettings(){closeModal('settingsModal');}
    function saveApiKey(){const k=document.getElementById('apiKeyInput').value.trim();if(k){localStorage.setItem('gemini_api_key',k);userApiKey=k;closeModal('settingsModal');showToast("API Key Ë®≠ÂÆöÊàêÂäü"); fetchAndAutoSelectModel();}else{showToast("Ë´ãËº∏ÂÖ• Key","error");}}
    function executeReset(){localStorage.removeItem('gemini_api_key');userApiKey='';closeModal('settingsModal');showToast("Key Â∑≤Ê∏ÖÈô§");setTimeout(()=>openSettings(),1000);}

    async function fetchAndAutoSelectModel() {
        if (!userApiKey) return;
        const select = document.getElementById('current-model-select');
        select.innerHTML = '<option>ÂÅµÊ∏¨‰∏≠...</option>'; select.disabled = true;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${userApiKey}`);
            const data = await res.json();
            if (!res.ok || !data.models) { select.innerHTML = '<option value="">(Key ÁÑ°Êïà)</option>'; return; }
            const availableModels = data.models.filter(m => m.supportedGenerationMethods.includes('generateContent')).map(m => m.name.replace('models/', ''));
            if (availableModels.length === 0) { select.innerHTML = '<option value="">(ÁÑ°ÂèØÁî®Ê®°Âûã)</option>'; return; }
            select.innerHTML = '';
            availableModels.sort((a, b) => { 
                if (a.includes('1.5-flash') && !b.includes('1.5-flash')) return -1;
                if (!a.includes('1.5-flash') && b.includes('1.5-flash')) return 1;
                return 0; 
            });
            availableModels.forEach(model => { const opt = document.createElement('option'); opt.value = model; opt.innerText = model; select.appendChild(opt); });
            select.disabled = false; selectedModel = availableModels[0]; select.value = selectedModel;
            showToast(`Â∑≤ÈÅ∏Êìá: ${selectedModel}`);
        } catch (e) { select.innerHTML = '<option value="gemini-1.5-flash">È†êË®≠(1.5 Flash)</option>'; selectedModel = 'gemini-1.5-flash'; }
    }
    function manualSelectModel() { selectedModel = document.getElementById('current-model-select').value; showToast(`Â∑≤ÂàáÊèõ: ${selectedModel}`); }

    window.onload=()=>{
        initApiKey();
        initLanguageSelects();
        checkSpeechSupport(); 
        handleResize(); 
        window.addEventListener('resize', handleResize);
        initDraggableMic('topMicBtn', 'top');
        initDraggableMic('bottomMicBtn', 'bottom');
        initSplitter();
        setupTextPlayback();
        
        document.getElementById('textInput').addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault(); 
                doTextTranslation();
            }
        });
    };
    
    function setupTextPlayback() {
        const bubbles = [
            {id: 'topOriginalText', getLangIdx: () => document.getElementById('voiceTopLang').value},
            {id: 'topTranslatedText', getLangIdx: () => document.getElementById('voiceTopLang').value},
            {id: 'bottomOriginalText', getLangIdx: () => document.getElementById('voiceBottomLang').value},
            {id: 'bottomTranslatedText', getLangIdx: () => document.getElementById('voiceBottomLang').value}
        ];

        bubbles.forEach(item => {
            const el = document.getElementById(item.id);
            el.addEventListener('click', (e) => {
                e.stopPropagation();
                const text = el.innerText;
                if(text && text !== '...') {
                    const langIndex = item.getLangIdx();
                    const langCode = languages[langIndex].speechCode;
                    speakText(text, langCode);
                }
            });
        });
    }

    function clearTextInput() {
        document.getElementById('textInput').value = '';
        document.getElementById('textOutput').value = '';
        showToast("ÂÖßÂÆπÂ∑≤Ê∏ÖÈô§");
    }

    function copyToClipboard(elementId) {
        const text = document.getElementById(elementId).innerText;
        if (!text || text === '...') {
            showToast("Ê≤íÊúâÊñáÂ≠óÂèØË§áË£Ω");
            return;
        }
        navigator.clipboard.writeText(text).then(() => {
            showToast("Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø");
        }).catch(err => {
            showToast("Ë§áË£ΩÂ§±Êïó", "error");
        });
    }

    function initSplitter() {
        const splitter = document.getElementById('splitter');
        const topHalf = document.getElementById('topHalf');
        const container = document.getElementById('voiceMirroredContainer');
        const headerControls = document.getElementById('headerControls');
        let isDragging = false;

        const onMove = (clientY) => {
            const rect = container.getBoundingClientRect();
            const relativeY = clientY - rect.top;
            const percentage = (relativeY / rect.height) * 100;
            if (percentage > 20 && percentage < 80) {
                topHalf.style.height = `${percentage}%`;
                if (document.body.classList.contains('voice-mode-portrait')) {
                    headerControls.style.top = `calc(${percentage}% + 20px)`;
                }
            }
        };

        const onTouchMove = (e) => { if(!isDragging) return; e.preventDefault(); onMove(e.touches[0].clientY); };
        const onMouseMove = (e) => { if(!isDragging) return; e.preventDefault(); onMove(e.clientY); };
        const onEnd = () => { isDragging = false; };

        splitter.addEventListener('mousedown', () => isDragging = true);
        splitter.addEventListener('touchstart', (e) => { isDragging = true; e.preventDefault(); }, {passive: false});
        window.addEventListener('mousemove', onMouseMove);
        window.addEventListener('touchmove', onTouchMove, {passive: false});
        window.addEventListener('mouseup', onEnd);
        window.addEventListener('touchend', onEnd);
        
        if (document.body.classList.contains('voice-mode-portrait')) {
             headerControls.style.top = `calc(50% + 20px)`;
        }
    }

    function handleResize() {
        const isPortrait = window.innerHeight > window.innerWidth;
        const isVoice = currentMode === 'voice';
        if (isPortrait && isVoice) { 
            document.body.classList.add('voice-mode-portrait'); 
            const topHalfHeight = document.getElementById('topHalf').style.height || '50%';
            if(topHalfHeight.includes('calc')) { document.getElementById('headerControls').style.top = 'calc(50% + 20px)'; } 
            else { document.getElementById('headerControls').style.top = `calc(${topHalfHeight} + 20px)`; }
        } 
        else { 
            document.body.classList.remove('voice-mode-portrait'); 
            document.getElementById('headerControls').style.top = ''; 
        }
    }

    function initLanguageSelects(){
        const ids = ['textSourceLang', 'textTargetLang', 'voiceTopLang', 'voiceBottomLang'];
        ids.forEach(id => { const el = document.getElementById(id); el.innerHTML = ''; languages.forEach((l,i)=>{ el.add(new Option(l.name,i)); }); });
        document.getElementById('textSourceLang').selectedIndex = 0; document.getElementById('textTargetLang').selectedIndex = 1;
        document.getElementById('voiceTopLang').selectedIndex = 1; document.getElementById('voiceBottomLang').selectedIndex = 0;
    }
    function syncLanguages(source) {}
    
    // ================= Debug ‰øÆÊ≠£ÂçÄ (iOS ÂÑ™Âåñ) =================
    function getSpeechRecognition() {
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SR) return null;
        const recog = new SR();
        
        // iOS Safari Â∞çÊñº continuous ÁöÑÊîØÊè¥Ê•µÂ∑ÆÔºåÂøÖÈ†àË®≠ÁÇ∫ false
        recog.continuous = false; 
        recog.interimResults = true;
        
        // ÂãïÊÖãÊ†πÊìöÁï∂ÂâçÊåâ‰∏ãÁöÑÂÅ¥ÈÇäË®≠ÁΩÆË™ûË®Ä
        recog.lang = (activeMicSide === 'top') ? 
            languages[document.getElementById('voiceTopLang').value].speechCode : 
            languages[document.getElementById('voiceBottomLang').value].speechCode;

        recog.onresult = (e) => {
            let interim = '', final = '';
            for(let i=e.resultIndex; i<e.results.length; ++i){ 
                if(e.results[i].isFinal) final += e.results[i][0].transcript; 
                else interim += e.results[i][0].transcript; 
            }
            const id = activeMicSide === 'top' ? 'topOriginalText' : 'bottomOriginalText'; 
            if (final || interim) {
                document.getElementById(id).innerText = final || interim;
            }
            if(final) window.lastFinalTranscript = final;
            if(interim) window.lastInterimTranscript = interim; 
        };

        recog.onerror = (e) => { 
            console.error("SR Error:", e.error);
            if (e.error !== 'no-speech') stopListening(); 
        };

        recog.onend = () => { 
            isListening = false; 
            updateMicUI(false);
            // ÂÑ™ÂÖàÂèñ finalÔºåËã• iOS Êú™Ê®ôË®ò final ÂâáÂèñ interim ‰ΩúÁÇ∫ fallback
            let textToTranslate = window.lastFinalTranscript || window.lastInterimTranscript;
            if(textToTranslate && activeMicSide) { 
                doVoiceTranslation(textToTranslate, activeMicSide); 
                window.lastFinalTranscript = ''; 
                window.lastInterimTranscript = ''; 
            } 
        };
        return recog;
    }

    function initDraggableMic(btnId, side) {
        const btn = document.getElementById(btnId);
        let startX, startY, startLeft, startTop;
        let isDragging = false;
        let dragThreshold = 10;
        let isPressing = false;

        const handleStart = (e) => {
            // iOS ÂøÖÈ†àÂú®ÈªûÊìäÁû¨ÈñìÂàùÂßãÂåñÊàñÈáçÁΩÆË™ûÈü≥ÁãÄÊÖã‰ª•Ëß£ÈéñÊ¨äÈôê
            if(synth) { synth.cancel(); }
            
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            startX = clientX; startY = clientY;
            startLeft = btn.offsetLeft; startTop = btn.offsetTop;
            
            isDragging = false; 
            isPressing = true;
            
            // Â¢ûÂä†ÂæÆÂ∞èÂª∂ÈÅ≤‰ª•Âà© UI ÂèçÈ•ãÔºå‰∏¶ÂïüÂãïÈåÑÈü≥
            setTimeout(() => {
                if(isPressing && !isDragging) startListening(side);
            }, 50);
        };

        const handleMove = (e) => {
            if(!isPressing) return;
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            const deltaX = clientX - startX;
            const deltaY = clientY - startY;

            if (!isDragging && (Math.abs(deltaX) > dragThreshold || Math.abs(deltaY) > dragThreshold)) { 
                isDragging = true; 
                stopListening(); 
            }
            if (isDragging) {
                if(e.type === 'touchmove') e.preventDefault();
                if (side === 'top') { 
                    btn.style.left = (startLeft - deltaX) + 'px'; 
                    btn.style.top = (startTop - deltaY) + 'px'; 
                } else { 
                    btn.style.left = (startLeft + deltaX) + 'px'; 
                    btn.style.top = (startTop + deltaY) + 'px'; 
                }
            }
        };

        const handleEnd = (e) => {
            if (!isPressing) return;
            isPressing = false; 
            // Á¢∫‰øùÊîæÈñãÊôÇÊòéÁ¢∫ÂÅúÊ≠¢ÔºåÂæûËÄåËß∏Áôº onend ÂõûË™øÈÄ≤Ë°åÁøªË≠Ø
            if (isListening) {
                stopListening();
            }
            isDragging = false; 
        };

        btn.addEventListener('mousedown', handleStart);
        btn.addEventListener('mousemove', handleMove);
        window.addEventListener('mouseup', handleEnd);
        
        btn.addEventListener('touchstart', handleStart, {passive: false}); 
        btn.addEventListener('touchmove', handleMove, {passive: false});
        window.addEventListener('touchend', handleEnd, {passive: false});
    }

    function checkSpeechSupport(){
        if(!('webkitSpeechRecognition'in window)&&!('SpeechRecognition'in window)){
            showToast("Ë´ãÁî® Chrome","error");document.getElementById('voiceModeBtn').disabled=true;
        } 
        // ÁßªÈô§‰∏çÂøÖË¶ÅÁöÑÈùû iOS ÂàùÂßãÂåñÈÇèËºØÔºåÁµ±‰∏ÄÁî± handleStart ÂãïÊÖãÂØ¶‰æãÂåñ
    }

    function switchMode(m){
        currentMode=m;
        document.getElementById('textModeBtn').classList.toggle('active',m==='text');
        document.getElementById('voiceModeBtn').classList.toggle('active',m==='voice');
        document.getElementById('textModeContainer').style.display=m==='text'?'flex':'none';
        document.getElementById('voiceMirroredContainer').style.display=m==='voice'?'flex':'none';
        handleResize();
    }

    async function callGeminiAPI(text, sP, tP) {
        if(!userApiKey){showToast("Ë´ãË®≠ÂÆö Key","error");openSettings();throw new Error("No Key");}
        const fallbackModels = ['gemini-1.5-flash', 'gemini-1.5-flash-8b', 'gemini-1.0-pro'];
        let attemptList = [selectedModel || 'gemini-1.5-flash'];
        fallbackModels.forEach(m => { if(!attemptList.includes(m)) attemptList.push(m); });
        const prompt=`You are a professional translator. Translate the following text from ${sP} to ${tP}. Output *only* the translated result. Do not include any thinking process, explanations, or notes. Text: "${text}"`;
        let lastError = null;
        for (const model of attemptList) {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${userApiKey}`,{
                    method:'POST',headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})
                });
                if(res.ok) { 
                    const data = await res.json(); 
                    if(data.candidates) {
                        let resultText = data.candidates[0].content.parts[0].text.trim();
                        resultText = resultText.replace(/<think>[\s\S]*?<\/think>/gi, "").trim();
                        return resultText;
                    } 
                }
                const err = await res.json(); lastError = err.error ? err.error.message : "Unknown Error";
                if(res.status === 429 || res.status === 404 || lastError.includes("limit: 0")) continue; else break;
            } catch(e) { lastError = e.message; }
        }
        showToast("ÁøªË≠ØÂ§±Êïó: È°çÂ∫¶‰∏çË∂≥ÊàñÁÑ°ÂèØÁî®Ê®°Âûã", "error"); return `[Á≥ªÁµ±Ë®äÊÅØ] ${lastError}`;
    }

    async function detectLanguage(text) {
        const langNames = languages.map(l => l.prompt).join(', ');
        const prompt = `Identify the language of the following text. Choose ONLY ONE from this list: [${langNames}]. Output only the language name. Text: "${text}"`;
        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${selectedModel || 'gemini-1.5-flash'}:generateContent?key=${userApiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (res.ok) {
                const data = await res.json();
                const detected = data.candidates[0].content.parts[0].text.trim();
                const index = languages.findIndex(l => detected.toLowerCase().includes(l.prompt.toLowerCase()));
                return index !== -1 ? index : null;
            }
        } catch (e) { console.error("Detection error:", e); }
        return null;
    }

    async function doTextTranslation(){
        const i=document.getElementById('textInput'),o=document.getElementById('textOutput'),b=document.getElementById('textTranslateBtn'),l=document.getElementById('textLoading');
        const sourceSelect = document.getElementById('textSourceLang');
        const targetSelect = document.getElementById('textTargetLang');
        
        if(!i.value.trim())return; 
        b.disabled=true; l.style.display='block'; o.value='';

        try{
            const detectedIdx = await detectLanguage(i.value);
            if (detectedIdx !== null && detectedIdx != sourceSelect.value) {
                sourceSelect.value = detectedIdx;
                showToast(`ÂÅµÊ∏¨Âà∞Ë™ûË®Ä: ${languages[detectedIdx].name}`);
                if (sourceSelect.value == targetSelect.value) {
                    targetSelect.value = (detectedIdx == 0) ? 1 : 0;
                }
            }

            const s=sourceSelect.value, t=targetSelect.value;
            o.value=await callGeminiAPI(i.value, languages[s].prompt, languages[t].prompt); 
        } catch(e){ 
            o.value="Error"; 
        } finally{ 
            b.disabled=false; l.style.display='none'; 
        }
    }
    
    function swapTextLanguages(){
        const s=document.getElementById('textSourceLang'),t=document.getElementById('textTargetLang'); [s.value,t.value]=[t.value,s.value];
        const i=document.getElementById('textInput'),o=document.getElementById('textOutput'); if(o.value){i.value=o.value;o.value='';}
    }
    function playTextTranslation() { const text = document.getElementById('textOutput').value; const targetLangIdx = document.getElementById('textTargetLang').value; if(text) speakText(text, languages[targetLangIdx].speechCode); else showToast("Ê≤íÊúâÂèØÊí≠ÊîæÁöÑÊñáÂ≠ó"); }

    function downloadTextAudio() {
        const text = document.getElementById('textOutput').value;
        const targetLangIdx = document.getElementById('textTargetLang').value;
        let langCode = languages[targetLangIdx].speechCode;
        if (!text) { showToast("Ê≤íÊúâÂÖßÂÆπÂèØ‰∏ãËºâ"); return; }
        if (text.length > 200) { showToast("ÊñáÂ≠óÈÅéÈï∑ÔºåGoogle TTS ÁÑ°Ê≥ï‰∏ãËºâ (Èôê200Â≠ó)", "error"); return; }
        if (langCode !== 'zh-TW') langCode = langCode.split('-')[0];
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=${langCode}&client=dict-chrome-ex`;
        const a = document.createElement('a');
        a.href = url; a.download = 'translation.mp3'; a.target = '_blank'; a.rel = 'noreferrer'; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function startListening(side){
        if(isListening) return;
        recognition = getSpeechRecognition(); // ÊØèÊ¨°ÂïüÂãïÂâçÂØ¶‰æãÂåñÔºåÁ¢∫‰øùÁç≤ÂæóÊúÄÊñ∞ÈÖçÁΩÆ
        activeMicSide=side; window.lastFinalTranscript = ''; window.lastInterimTranscript = '';
        
        document.getElementById(side+'OriginalText').innerText='...'; 
        document.getElementById((side==='top'?'bottom':'top')+'TranslatedText').innerText='...';
        
        isListening = true; 
        updateMicUI(true);
        try { recognition.start(); } catch(e) { console.error("Start Error:", e); isListening = false; updateMicUI(false); }
    }
    
    function stopListening(){ if(recognition) { recognition.stop(); } isListening = false; updateMicUI(false); }
    function updateMicUI(l){ document.getElementById('topMicBtn').classList.toggle('listening',l&&activeMicSide==='top'); document.getElementById('bottomMicBtn').classList.toggle('listening',l&&activeMicSide==='bottom'); }
    
    async function doVoiceTranslation(text, side){
        const topIdx = document.getElementById('voiceTopLang').value; const bottomIdx = document.getElementById('voiceBottomLang').value;
        let sP, tP, out, speechLang;
        if(side==='top'){ sP=languages[topIdx].prompt; tP=languages[bottomIdx].prompt; out='bottomTranslatedText'; speechLang=languages[bottomIdx].speechCode; } 
        else { sP=languages[bottomIdx].prompt; tP=languages[topIdx].prompt; out='topTranslatedText'; speechLang=languages[topIdx].speechCode; }
        const r=await callGeminiAPI(text, sP, tP);
        document.getElementById(out).innerText=r;
        if(!r.startsWith("[")) speakText(r, speechLang);
    }

    function speakText(t, l) {
        if (!synth) return; synth.cancel();
        const voices = synth.getVoices();
        if (voices.length === 0) { setTimeout(() => speakText(t, l), 100); return; }
        const u = new SpeechSynthesisUtterance(t); u.lang = l; u.rate = 1.0; 
        let v = voices.find(voice => voice.lang === l);
        if (!v) v = voices.find(voice => voice.lang.startsWith(l.split('-')[0]));
        if (v) u.voice = v; 
        synth.speak(u);
    }
</script>
</body>
</html>